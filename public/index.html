<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
      integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="css/style.css" /> 
    <title>Chatify App</title>
  </head>

  <body>
    <!-- 1. GLOBAL HEADER / NAVIGATION (Fixed to top) -->
    <header class="global-header">
        <div class="header-logo">
            <i class="fas fa-comment"></i> Chatify
        </div>
        <nav class="header-nav">
            <a href="#home-section" class="nav-link active" data-target="home-section">Home</a>
            <a href="#about-section" class="nav-link" data-target="about-section">About</a>
            <a href="#help-section" class="nav-link" data-target="help-section">Help</a>
            <a href="#contact-footer" class="nav-link" data-target="contact-section">Contact</a>
        </nav>
        <button class="history-toggle" id="history-toggle">
            <i class="fas fa-history"></i> History
        </button>
    </header>

    <!-- 2. HISTORY SLIDEBAR -->
    <aside class="history-sidebar" id="history-sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-history"></i> Room History</h3>
            <button class="close-history" id="history-close-button">&times;</button>
        </div>
        <ul class="history-list">
            <li>[10:30 AM] Joined: Cyber Security</li>
        </ul>
    </aside>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- 3. SCROLLABLE MAIN CONTENT AREA -->
    <main class="content-scroll-wrapper">
        
        <!-- HOME SECTION: Initial Centered View -->
        <section id="home-section" class="content-section home-section-style">
            <div class="join-container">
                <header class="join-header"> 
                    <h1 class="white-text"><i class="fas fa-comment"></i> Chatify</h1>
                </header>

                <div class="join-main">
                    <form id="join-form" action="/validate" method="POST">
                        <div class="form-control">
                            <label for="username">Username</label>
                            <input type="text" name="username" id="username" placeholder="Enter username..." required />
                        </div>

                        <div class="form-control">
                            <label for="room-select">Room</label>
                            <select id="room-select" name="room"></select>
                            <input type="text" id="custom-room-input" placeholder="Enter NEW Room Name..."/>
                        </div>

                        <div class="form-control">
                            <div class="key">
                                <label for="key">Room Security Key</label>
                                <input type="password" placeholder="Enter Room Security Key..." name="key" id="key" class="key-input" required />
                            </div>
                        </div>

                        <div class="button-container">
                            <button type="submit" id="join-btn" class="btn">Join Chat</button>
                            <button type="button" id="create-btn" class="btn btn-create">Create New Room</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        
        <!-- ABOUT SECTION: PROFESSIONAL SCROLLABLE CONTENT -->
        <section id="about-section" class="content-section info-section-style">
            <div class="about-theme-container">
                <h2 class="theme-title">Our Mission: Enterprise-Grade Secure Messaging</h2>
                
                <div class="card-grid">
                    
                    <div class="about-card interactive-card">
                        <i class="fas fa-microchip icon-large"></i>
                        <h3>Scalable Architecture</h3>
                        <p>Built on the **MEAN stack (MongoDB, Express, Node.js)** and **Socket.io** for high-speed, real-time data exchange.</p>
                    </div>
                    
                    <div class="about-card interactive-card">
                        <i class="fas fa-lock icon-large"></i>
                        <h3>Cryptographic Security</h3>
                        <p>We utilize **Cryptr** for End-to-End Encryption (E2EE) of messages and industry-standard **bcrypt** for robust password hashing.</p>
                    </div>
                    
                    <div class="about-card interactive-card">
                        <i class="fas fa-users-cog icon-large"></i>
                        <h3>Dynamic Room Creation</h3>
                        <p>Users are empowered to instantly create and secure new private group channels, ensuring autonomous control.</p>
                    </div>
                    
                    <div class="about-card quick-links-card interactive-card">
                        <h3>Next Steps</h3>
                        <ul>
                            <li><a href="#home-section" class="nav-link" data-target="home-section">Access Chat Portal <i class="fas fa-arrow-right"></i></a></li>
                            <li><a href="#" id="about-history-link">Review Session History <i class="fas fa-history"></i></a></li>
                            <li><a href="#help-section" class="nav-link" data-target="help-section">Documentation & Support <i class="fas fa-question-circle"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- HELP SECTION: PROFESSIONAL FAQ -->
        <section id="help-section" class="content-section info-section-style">
            <div class="info-box help-box">
                <h2 class="theme-title">Technical Support & FAQ</h2>
                
                <h3 class="help-question">Q: What database is used for room persistence?</h3>
                <p class="help-answer">A: We leverage **MongoDB** to handle the persistent storage of room names and their associated secure bcrypt hashes.</p>
                
                <h3 class="help-question">Q: How is the 'cannot POST /create' error prevented?</h3>
                <p class="help-answer">A: Client-side JavaScript dynamically sets the form action to the correct server endpoint, `/create`, ensuring reliable server communication before submission.</p>
                
                <h3 class="help-question">Q: How do I ensure my custom room name appears in the dropdown?</h3>
                <p class="help-answer">A: Once created, the room name is saved in the database, and the client automatically fetches the updated room list via the `/rooms` API endpoint upon every page load.</p>
            </div>
        </section>

    </main>
    
    <!-- 4. GLOBAL FOOTER (Contact Info) -->
    <footer class="global-footer" id="contact-footer">
        <div class="footer-content">
            <h4>Connect with Us</h4>
            <div class="social-links">
                <a href="https://www.linkedin.com" target="_blank" rel="noopener noreferrer" title="Chatify LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a>
                <a href="https://www.twitter.com" target="_blank" rel="noopener noreferrer" title="Chatify Twitter"><i class="fab fa-twitter"></i> Twitter</a>
                <a href="https://www.instagram.com" target="_blank" rel="noopener noreferrer" title="Chatify Instagram"><i class="fab fa-instagram"></i> Instagram</a>
            </div>
            <p>&copy; 2025 Chatify App | Enterprise Secure Communication</p>
        </div>
    </footer>

    <script>
        // --- ALL JAVASCRIPT LOGIC ---
        
        const form = document.getElementById('join-form');
        const roomSelect = document.getElementById('room-select');
        const customRoomInput = document.getElementById('custom-room-input');
        const joinBtn = document.getElementById('join-btn');
        const createBtn = document.getElementById('create-btn');

        // --- Navigation & Sidebar Logic ---
        const navLinks = document.querySelectorAll('.header-nav .nav-link');
        const historyToggle = document.getElementById('history-toggle');
        const historySidebar = document.getElementById('history-sidebar');
        const closeHistory = document.getElementById('history-close-button'); 
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function toggleSidebar(show) {
            historySidebar.classList.toggle('open', show);
            sidebarOverlay.style.display = show ? 'block' : 'none';
        }
        historyToggle.addEventListener('click', () => toggleSidebar(true));
        closeHistory.addEventListener('click', () => toggleSidebar(false));
        sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

        // --- Navigation Logic (Smooth Scrolling) ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                const targetElement = document.querySelector(link.getAttribute('href'));

                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }
                
                navLinks.forEach(nl => nl.classList.remove('active'));
                link.classList.add('active');
            });
        });

        document.getElementById('about-history-link').addEventListener('click', (e) => {
            e.preventDefault();
            toggleSidebar(true);
        });

        // --- Room Logic (Functions) ---
        function toggleRoomMode(isCreateMode) {
            if (isCreateMode) {
                customRoomInput.style.display = 'block';
                joinBtn.style.display = 'none';
                createBtn.style.display = 'block';
                roomSelect.removeAttribute('name');
                customRoomInput.setAttribute('name', 'room');
            } else {
                customRoomInput.style.display = 'none';
                joinBtn.style.display = 'block';
                createBtn.style.display = 'none';
                customRoomInput.removeAttribute('name');
                roomSelect.setAttribute('name', 'room');
            }
        }
        
        async function fetchRooms() {
             try {
                // 1. Fetch data from the server's custom API endpoint
                const response = await fetch('/rooms');
                
                // CRITICAL FIX: Check response status before parsing JSON
                if (!response.ok) {
                    console.error(`HTTP error! status: ${response.status}`);
                    // If server isn't running, this will trigger the fallback
                    throw new Error('Server fetch failed.'); 
                }
                const roomNames = await response.json();
                
                roomSelect.innerHTML = '';
                
                // 2. Populate the dropdown with fetched rooms
                roomNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    roomSelect.appendChild(option);
                });

                // 3. Add the required "Create New Room" option last
                const createOption = document.createElement('option');
                createOption.value = 'create-new';
                createOption.textContent = '— Create New Room —';
                roomSelect.appendChild(createOption);
                
                toggleRoomMode(false);
                
                // Select the first room (e.g., 'cybersec')
                if (roomNames.length > 0) {
                     roomSelect.value = roomNames[0]; 
                }

            } catch (error) {
                console.error("Failed to load rooms:", error);
                // Fallback: If network fails, still allow manual room creation
                roomSelect.innerHTML = '<option value="create-new">— Create New Room —</option>';
                toggleRoomMode(true);
            }
        }

        roomSelect.addEventListener('change', (e) => {
            const isCreateMode = e.target.value === 'create-new';
            toggleRoomMode(isCreateMode);
        });

        createBtn.addEventListener('click', () => {
            form.action = '/create';
            form.submit(); 
        });

        joinBtn.addEventListener('click', () => {
            form.action = '/validate'; 
        });

        form.addEventListener('submit', (e) => {
            const isCreateMode = roomSelect.value === 'create-new';
            toggleRoomMode(isCreateMode);
        });

        // Execute fetch on page load
        fetchRooms();
    </script>
  </body>
</html>